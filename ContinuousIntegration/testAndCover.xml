<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="RunTests" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" >

  <PropertyGroup>
    <SolutionRoot>$(MSBuildProjectDirectory)\..\</SolutionRoot>
    <NUnit-ToolPath>$(SolutionRoot)\packages\NUnit.Runners.2.6.1\tools\</NUnit-ToolPath>
    <OpenCover-ToolPath>$(SolutionRoot)\packages\OpenCover.4.0.804\</OpenCover-ToolPath>
    <ReportGenerator-ToolPath>$(SolutionRoot)\packages\ReportGenerator.1.6.0.0\</ReportGenerator-ToolPath>
    <MSBuildCommunityTasksPath>$(SolutionRoot)\tools\msbuild\MSBuildCommunityTasks\</MSBuildCommunityTasksPath>
    
    <ReportsPath>$(SolutionRoot)\_reports\</ReportsPath>
    <CodeCoverageResultsPath>$(SolutionRoot)\_reports\CodeCoverageResults.xml</CodeCoverageResultsPath>
  </PropertyGroup>
  <Import Project="$(MSBuildCommunityTasksPath)\MSBuild.Community.Tasks.Targets"/>
  <UsingTask TaskName="SetEnvVariable"
             AssemblyFile="$(SolutionRoot)\tools\MSBuild.SetEnvVariable\MSBuild.SetEnvVariable.dll"/>

  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>

    <!-- list of test assemblies (space separated) -->
    <TestAssemblies>$(SolutionRoot)\_bin\$(Configuration)\Tests.Analytics.dll $(SolutionRoot)\_bin\$(Configuration)\Tests.Functional.dll</TestAssemblies>
    <!-- list of assembly filters (space separated) - see https://github.com/sawilde/opencover/wiki/Usage -filter: for syntax-->
    <OpenCoverFilter>+[*]* -[Test*]* -[ApiGeoIP*]* -[CassiniDev*]*</OpenCoverFilter>
  </PropertyGroup>

  <Target Name="RunTests" >
    <Message Text="Executing Unit Tests and running OpenCover to check code coverage..." />

    <SetEnvVariable Name="AppMetricsTest_ServiceRootFolder" Value="$(AppMetricsTest_ServiceRootFolder)"/>
    <SetEnvVariable Name="AppMetricsTest_DataFolder" Value="$(AppMetricsTest_DataFolder)"/>
    <SetEnvVariable Name="AppMetricsTest_AccessKey" Value="$(AppMetricsTest_AccessKey)"/>

    <MakeDir Directories="$(AppMetricsTest_DataFolder)" />

    <RemoveDir Directories="$(ReportsPath)" />
    <MakeDir Directories="$(ReportsPath)" />

    <Exec Command='"$(OpenCover-ToolPath)\OpenCover.Console.exe" -register:user -target:"$(NUnit-ToolPath)\nunit-console-x86.exe" "-targetargs:$(TestAssemblies)" "-targetdir:$(SolutionRoot)\_bin\$(Configuration)" "-filter:$(OpenCoverFilter)" -output:$(CodeCoverageResultsPath)' />
    <Exec Command='$(ReportGenerator-ToolPath)ReportGenerator.exe "-reports:$(CodeCoverageResultsPath)" "-targetdir:$(ReportsPath)\coveragereport" "-reporttypes:html;htmlsummary;xmlsummary"' />
  </Target>

</Project>
